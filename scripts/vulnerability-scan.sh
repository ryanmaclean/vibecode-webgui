#!/bin/bash

# Vulnerability scanning with npm audit and Snyk
# Fails if high or critical vulnerabilities are found

set -e

echo "üîç Running vulnerability scan..."

# Check if npm audit passes
echo "üì¶ Running npm audit..."
if npm audit --audit-level=high; then
    echo "‚úÖ npm audit passed"
else
    echo "‚ùå npm audit found high/critical vulnerabilities"
    echo "üìã Detailed audit report:"
    npm audit --audit-level=moderate
    exit 1
fi

# Check with Snyk if available
if command -v snyk &> /dev/null; then
    echo "üîç Running Snyk security scan..."
    
    # Test for vulnerabilities
    if snyk test --severity-threshold=high; then
        echo "‚úÖ Snyk security scan passed"
    else
        echo "‚ùå Snyk found high/critical vulnerabilities"
        echo "üìã Detailed Snyk report:"
        snyk test --severity-threshold=medium
        exit 1
    fi
else
    echo "‚ö†Ô∏è  Snyk not available, skipping Snyk scan"
    echo "üí° Install Snyk CLI for enhanced security scanning: npm install -g snyk"
fi

# Additional security checks
echo "üîí Running additional security checks..."

# Check for known malicious packages
MALICIOUS_PACKAGES=(
    "event-stream"
    "eslint-scope"
    "getcookies"
    "http-server-plus"
    "loadtest"
)

for package in "${MALICIOUS_PACKAGES[@]}"; do
    if grep -q "\"$package\"" package.json; then
        echo "‚ùå Found known malicious package: $package"
        exit 1
    fi
done

# Check for forbidden licenses (GPL/LGPL/AGPL)
echo "üö´ Checking for forbidden GPL/LGPL/AGPL licenses..."
FORBIDDEN_LICENSES=("GPL" "LGPL" "AGPL" "GPL-2.0" "GPL-3.0" "LGPL-2.0" "LGPL-2.1" "LGPL-3.0" "AGPL-3.0")

if command -v license-checker &> /dev/null; then
    for license in "${FORBIDDEN_LICENSES[@]}"; do
        if license-checker --production --onlyunknown | grep -i "$license"; then
            echo "‚ùå FORBIDDEN LICENSE DETECTED: $license"
            echo "üö® GPL/LGPL/AGPL licenses are not allowed in this project!"
            exit 1
        fi
    done
fi

echo "‚úÖ All security checks passed"